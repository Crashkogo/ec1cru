# Система управления рассылками

## Описание

Полноценная система управления email-рассылками с поддержкой:

- ✅ Создания и управления шаблонами рассылок
- ✅ Планирования отправки на определенную дату/время
- ✅ Контроля скорости отправки (защита от спама)
- ✅ Автоматической отписки через email
- ✅ Отслеживания статуса кампаний
- ✅ Безопасной отправки с несуществующих ящиков

## Настройка

### 1. Переменные окружения

Создайте файл `.env` в корне backend с следующими переменными:

```bash
# База данных
DATABASE_URL="postgresql://username:password@localhost:5432/database_name"

# JWT секрет для токенов
JWT_SECRET="your-super-secret-jwt-key-here"

# Email настройки для рассылок
EMAIL_USER="your-email@ec-1c.ru"
EMAIL_PASS="your-email-password"

# URL фронтенда для ссылок отписки
FRONTEND_URL="http://localhost:5173"

# Порт сервера
PORT=3000
```

### 2. Настройка SMTP

Система использует nodemailer с возможностью отправки с любого адреса на вашем домене.

**Для отправки с no-reply@ec-1c.ru:**

1. Настройте SMTP сервер домена ec-1c.ru
2. Укажите корректные EMAIL_USER и EMAIL_PASS в .env
3. В коде система автоматически отправляет от имени `"1С Поддержка" <no-reply@ec-1c.ru>`

### 3. База данных

Примените миграции:

```bash
cd backend
npx prisma generate
npx prisma db push
```

### 4. Cron для запланированных рассылок

Для автоматической отправки запланированных рассылок настройте cron:

```bash
# Добавьте в crontab (каждые 5 минут)
*/5 * * * * /usr/bin/node /path/to/your/backend/dist/scripts/processScheduledNewsletters.js

# Или ежечасно для экономии ресурсов
0 * * * * /usr/bin/node /path/to/your/backend/dist/scripts/processScheduledNewsletters.js
```

Альтернативно, можете вызывать эндпоинт через API:

```bash
curl -X POST "http://your-api/api/posts/newsletters/process-scheduled" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## Использование

### Создание шаблона рассылки

1. Перейдите в админ-панель → Рассылки
2. Создайте новый шаблон с HTML-контентом
3. Используйте TinyMCE редактор для форматирования

### Отправка рассылки

1. Перейдите в админ-панель → Отправка рассылок
2. Выберите шаблон
3. Укажите тему письма (опционально)
4. Для немедленной отправки - нажмите "Отправить сейчас"
5. Для запланированной - укажите дату/время и нажмите "Запланировать"

### Управление подписчиками

- Публичная форма подписки доступна через API: `POST /api/posts/subscribers/subscribe`
- Управление подписчиками в админке: Подписчики
- Отписка через ссылку в письме происходит автоматически

## Лимиты и безопасность

### Контроль скорости отправки

- **30 писем в минуту** - безопасный лимит для большинства SMTP
- **1000 писем в час** - дневной лимит
- **Батчи по 5 писем** с паузой 2 секунды между батчами

### Заголовки для доставляемости

```
List-Unsubscribe: <https://your-site.com/unsubscribe?token=...>
List-Unsubscribe-Post: List-Unsubscribe=One-Click
X-Mailer: 1C Support Newsletter System
```

### Безопасность отписки

- Токены генерируются с помощью crypto + JWT_SECRET
- Каждая ссылка отписки уникальна
- Отписка происходит без авторизации пользователя

## API Эндпоинты

### Управление рассылками

```
POST /api/posts/newsletters/send
GET /api/posts/newsletters/queue/status
GET /api/posts/newsletters/campaigns
POST /api/posts/newsletters/process-scheduled
```

### Подписчики

```
POST /api/posts/subscribers/subscribe - публичный эндпоинт
GET /api/posts/unsubscribe?token=...&subscriber=... - публичная отписка
```

## Мониторинг

### Статус очереди

В интерфейсе отправки рассылок отображается:

- Количество писем в очереди
- Статус обработки
- Отправлено за минуту/час
- Индикатор достижения лимитов

### Статусы кампаний

- **SCHEDULED** - запланирована
- **SENDING** - отправляется
- **COMPLETED** - завершена
- **FAILED** - ошибка

## Лучшие практики

### Содержание писем

1. Используйте четкие темы писем
2. Добавляйте персонализацию где возможно
3. Включайте call-to-action кнопки
4. Делайте мобильную версию (CSS responsive)

### Периодичность

1. Не отправляйте чаще 1-2 раз в неделю
2. Планируйте отправку на рабочие дни
3. Избегайте праздничные дни

### Отписка

1. Ссылка отписки добавляется автоматически
2. Процесс отписки в один клик
3. Не удаляйте отписавшихся, а деактивируйте (для соблюдения GDPR)

## Решение проблем

### Письма не отправляются

1. Проверьте настройки SMTP в .env
2. Убедитесь, что EMAIL_USER и EMAIL_PASS корректны
3. Проверьте логи сервера

### Письма попадают в спам

1. Настройте SPF/DKIM/DMARC записи для домена
2. Прогрейте IP/домен постепенными отправками
3. Используйте качественный контент без спам-слов

### Отписка не работает

1. Проверьте, что FRONTEND_URL указан правильно
2. Убедитесь, что роут /unsubscribe настроен во фронтенде
3. Проверьте JWT_SECRET в .env

## Расширения

Система готова к расширению:

- Добавление A/B тестирования шаблонов
- Интеграция с внешними сервисами аналитики
- Персонализация контента по сегментам
- Автоматические trigger-рассылки
